import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import math

dfChild = pd.read_csv("Apps.csv")
dfChildReview = pd.read_csv("Reviews.csv")
dfParent = pd.read_csv("googleplaystore.csv")
dfParentReview = pd.read_csv("googleplaystore_user_reviews.csv")

# Identified and renamed the primary keys on the datasets 
dfParent.rename(columns={"App": "App Name"}, inplace= True)
dfParentReview.rename(columns={"App": "App Name"}, inplace= True)
dfChild.rename(columns={"title": "App Name"}, inplace= True)

# Paired the App Name column in order to have the same apps to analyze the affect of the external factor (covid-19) in further processes
# Seperately dropped the unmatched ones in the datasets 
merged = pd.merge(dfParent['App Name'], dfChild['App Name'], how='outer', indicator=True)
unmatched = merged[merged['_merge'] == 'left_only']['App Name']
unmatched_2 = merged[merged['_merge'] == 'right_only']['App Name']
dfParent = dfParent[~dfParent['App Name'].isin(unmatched)]
dfChild = dfChild[~dfChild['App Name'].isin(unmatched_2)]
dfParent = dfParent.drop_duplicates(['App Name'])
dfChild = dfChild.drop_duplicates(['App Name'])

# Merged the main 2 datasets in order to see the reviews and other details of the applications
# Since the App Name column is updated the aim is to compare the reviews, emotions etc. with and without the effect of the external factor
dfParentMerged = pd.DataFrame(pd.merge(dfParent, dfParentReview, on="App Name", how="inner"))
#print(dfParentMerged)
#n = dfParentMerged[["App Name"]].nunique()
#print(n)

# Dropped the unnecessary columns
dfParentMerged.drop("Last Updated", axis=1, inplace=True)
dfParentMerged.drop("Current Ver", axis=1, inplace= True)
dfParentMerged.drop("Android Ver", axis=1, inplace=True)
dfParentMerged.drop("Sentiment", axis=1, inplace=True)
dfParentMerged.drop("Sentiment_Polarity", axis=1, inplace=True)
dfParentMerged.drop("Sentiment_Subjectivity", axis=1, inplace=True)

# From now on all the iterations' aim is to set the correct type of the data

# Tidied the size column whereas the steps:
# Filled "Varies with device" rows with the mean of the size
# Dropped M,k in order to have unit as Bayt
# Filled the blanks with the mean of the size
filtered_rows = dfParentMerged.loc[dfParentMerged["Size"].str.contains("Varies with device")]
filtered_rows_1 = dfParentMerged.loc[dfParentMerged["Size"].str.contains("M")]
filtered_rows_2 = dfParentMerged.loc[dfParentMerged["Size"].str.contains("k")]

if not filtered_rows.empty:
    dfParentMerged.loc[filtered_rows.index, "Size"] = None
if not filtered_rows_1.empty:
    dfParentMerged.loc[filtered_rows_1.index, "Size"] = filtered_rows_1["Size"].str.replace("M", "").astype(float) * 1048576
if not filtered_rows_2.empty:
    dfParentMerged.loc[filtered_rows_2.index, "Size"] = filtered_rows_2["Size"].str.replace("k", "").astype(float) * 1024
    
dfParentMerged["Size"] = dfParentMerged["Size"].astype(float)

dfParentMerged["Size"] = dfParentMerged["Size"].fillna(dfParentMerged["Size"].mean())
#print(dfParentMerged["Size"])

#Tidied Installs column 
dfParentMerged["Installs"] = dfParentMerged["Installs"].str.replace("+","", regex=False)
dfParentMerged["Installs"] = dfParentMerged["Installs"].str.replace(",","", regex=False)
dfParentMerged["Installs"] = dfParentMerged["Installs"].astype(float)
#print(dfParentMerged["Installs"])

#Tidied Price column
dfParentMerged["Price"] = dfParentMerged["Price"].str.replace("$","", regex=False)
dfParentMerged["Price"] = dfParentMerged["Price"].astype(float)
#print(dfParentMerged["Price"])

#Tidied Other columns
dfParentMerged["Rating"] = dfParentMerged["Rating"].astype(float)
dfParentMerged["Reviews"] = dfParentMerged["Reviews"].astype(float)
dfParentMerged["Type"] = dfParentMerged["Type"].astype(str)
dfParentMerged["App Name"] = dfParentMerged["App Name"].astype(str)
dfParentMerged["Category"] = dfParentMerged["Category"].astype(str)
dfParentMerged["Content Rating"] = dfParentMerged["Content Rating"].astype(str)
dfParentMerged["Genres"] = dfParentMerged["Genres"].astype(str)
dfParentMerged["Translated_Review"] = dfParentMerged["Translated_Review"].astype(str)

#dfParentMerged.info()
